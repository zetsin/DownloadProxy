<!DOCTYPE html>
<html>
	<head>
		<title>Zetsin</title>

		<!-- Stylesheets -->
		<link rel="stylesheet" type="text/css" href="/lib/photon/css/photon.min.css">

	</head>

	<body>
		<!-- Wrap your entire app inside .window -->
		<div class="window">
			<header class="toolbar toolbar-header">
				<div class="toolbar-actions">
					<div style="display: flex;">
						<input id="url" class="form-control" type="text" placeholder="这儿输入要下载的网址" style="flex: 1;" title="回车开始下载">
						<button id="download" class="btn btn-default pull-right" title="开始下载">
							<span class="icon icon-download"></span>
						</button>
						<select id="name" class="form-control" style="width: initial;" title="以...命名">
							<option value="url">网址</option>
							<option value="name">文件名</option>
							<option value="random">随机字符</option>
						</select>
					</form>
				</div>
			</header>

			<!-- Your app's content goes inside .window-content -->
			<div class="window-content">
				<div class="pane-group">
					<div class="pane">
						<table id="files" class="table-striped"></table>
					</div>
					<div class="pane pane-sm sidebar">
						<div class="toolbar-actions">
							<h1 class="title">正在下载...</h1>
						</div>
						<div id="downloading"></div>
					</div>
				</div>
			</div>
		</div>
		<script type="text/javascript" src="/lib/jquery.js"></script>
		<script type="text/javascript">
			$(() => {
				getDownload()
				setInterval(getDownload, 1000)

				$('#download').on('click', () => {
					download()
				})
				$('#url').on('keydown', (e) => {
					if(e.keyCode == 13) {
						download()
					}
				})

				function download() {
					open(`/${encodeURIComponent($('#url').val())}?name=${$('#name').val()}`)
				}

				function getDownload() {
					$.get('/download', (result) => {
						console.log(result.downloaded.length)
						result.downloaded.sort((a, b) => {
							if(a.file == 'README.md'){
								return -1
							} else if(b.file == 'README.md') {
								return 1
							}
							return b.birthtime - a.birthtime
						})
						let $tr = ''
						result.downloaded.forEach((item) => {
							$tr += `
								<tr>
									<td><a href="/download/${encodeURIComponent(item.file)}" target="_blank">${decodeURIComponent(item.file)}</a></td>
									<td>${prettyBytes(item.size)}</td>
									<td>${new Date(item.birthtime)}</td>
								</tr>
							`
						})
						$('#files').html(`
							<thead>
								<tr>
									<th>名字</th>
									<th>大小</th>
									<th>创建时间</th>
								</tr>
							</thead>
							<tbody>${$tr}</tbody>
						`)

						let $li = ''
						result.downloading.forEach((item) => {
							$li += `<li class="list-group-item" title="${item.file}">
								<strong>${item.file}</strong>
								<p>${prettyBytes(item.current/(Date.now() - item._t) * 1000)}/s - ${prettyBytes(item.current)} of ${prettyBytes(item.total)}</p>
							</li>`
						})
						$('#downloading').html(`
							<ul class="list-group">${$li}</ul>
						`)
					})
				}

				function prettyBytes(num) {
					num = parseFloat(num)

					var exponent;
					var unit;
					var neg = num < 0;
					var units = ['B', 'KB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB'];

					if (neg) {
						num = -num;
					}

					if (num < 1) {
						return (neg ? '-' : '') + num + ' B';
					}

					exponent = Math.min(Math.floor(Math.log(num) / Math.log(1000)), units.length - 1);
					num = Number((num / Math.pow(1000, exponent)).toFixed(2));
					unit = units[exponent];

					return (neg ? '-' : '') + num + ' ' + unit;
				}
 			})
		</script>
	</body>
</html>